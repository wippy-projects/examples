version: "1.0"
namespace: app

entries:
  # ── Dependencies ────────────────────────────────────────────
  - name: __dependency.llm
    kind: ns.dependency
    component: wippy/llm
    version: "*"
    parameters:
      - name: env_storage
        value: app:file_env
      - name: process_host
        value: app:processes

  - name: views
    kind: ns.dependency
    component: wippy/views
    version: "*"
    parameters:
      - name: api_router
        value: app:router_http

  # ── Hosts ──────────────────────────────────────────────────
  - name: terminal
    kind: terminal.host
    lifecycle:
      auto_start: true

  - name: processes
    kind: process.host
    lifecycle:
      auto_start: true

  # ── HTTP Infrastructure ────────────────────────────────────
  - name: gateway
    kind: http.service
    addr: ":8080"
    lifecycle:
      auto_start: true

  - name: router_http
    kind: http.router
    meta:
      server: app:gateway
    prefix: /

  # ── Templates ──────────────────────────────────────────────
  - name: templates
    kind: template.set

  - name: layout
    kind: template.jet
    set: app:templates
    source: file://templates/layout.jet

  - name: chat_page
    kind: template.jet
    set: app:templates
    source: file://templates/chat.jet
    meta:
      type: view.page
      title: "The Rusty Flagon"
      path: /
    data_func: app:chat_data

  # ── Page Handler ───────────────────────────────────────────
  - name: chat_data
    kind: function.lua
    source: file://handlers/chat_data.lua
    method: handler

  - name: page
    kind: function.lua
    source: file://handlers/page.lua
    method: handler
    modules: [http]
    imports:
      renderer: wippy.views:renderer

  - name: page.endpoint
    kind: http.endpoint
    meta:
      router: app:router_http
    method: GET
    path: /
    func: app:page

  # ── WebSocket Router ─────────────────────────────────────
  - name: ws_router
    kind: http.router
    meta:
      server: app:gateway
    prefix: /ws
    post_middleware:
      - websocket_relay
    post_options:
      wsrelay.allowed.origins: "*"

  # ── WS Connect Handler ──────────────────────────────────
  - name: ws_connect
    kind: function.lua
    source: file://handlers/ws_connect.lua
    method: handler
    modules: [http, json]

  - name: ws_connect.endpoint
    kind: http.endpoint
    meta:
      router: app:ws_router
    method: GET
    path: /chat
    func: app:ws_connect

  # ── Shared Libraries ─────────────────────────────────────
  - name: prompts
    kind: library.lua
    source: file://lib/prompts.lua
    modules: []

  # ── Session Process ──────────────────────────────────────
  - name: session_process
    kind: process.lua
    source: file://session.lua
    method: main
    modules: [json, logger, time, registry]
    imports:
      prompts: app:prompts

  # ── Environment ────────────────────────────────────────────
  - name: file_env
    kind: env.storage.file
    file_path: ./.env
    auto_create: true

  # ── Models ─────────────────────────────────────────────────
  - name: gpt_4o_mini
    kind: registry.entry
    meta:
      type: llm.model
      name: gpt-4o-mini
      title: GPT-4o Mini
      class: [ fast, chat ]
      capabilities: [ generate, tool_use, structured_output ]
      priority: 100
    providers:
      - id: wippy.llm.openai:provider
        provider_model: gpt-4o-mini
        options:
          temperature: 0.9
          max_tokens: 512

  # ── Agent Process ──────────────────────────────────────────
  - name: agent_process
    kind: process.lua
    source: file://agent.lua
    method: main
    modules:
      - logger
    imports:
      llm: wippy.llm:llm
      prompt: wippy.llm:prompt

  - name: agent
    kind: process.service
    process: app:agent_process
    host: app:processes
    lifecycle:
      auto_start: true
      restart:
        max_attempts: 5
        initial_delay: 1s
        backoff_factor: 2.0

  # ── Router Process ────────────────────────────────────────
  - name: router_process
    kind: process.lua
    source: file://router.lua
    method: main
    modules:
      - logger
      - registry
    imports:
      llm: wippy.llm:llm

  - name: router
    kind: process.service
    process: app:router_process
    host: app:processes
    lifecycle:
      auto_start: true
      restart:
        max_attempts: 5
        initial_delay: 1s
        backoff_factor: 2.0

  # ── NPC Manager Process ─────────────────────────────────
  - name: npc_manager_process
    kind: process.lua
    source: file://npc_manager.lua
    method: main
    modules:
      - logger
      - registry
      - time

  - name: npc_manager
    kind: process.service
    process: app:npc_manager_process
    host: app:processes
    lifecycle:
      auto_start: true
      restart:
        max_attempts: 5
        initial_delay: 1s
        backoff_factor: 2.0

  # ── Tavern NPCs (add more registry.entry with meta.type: bar.npc) ──
  - name: npc.bartender
    kind: registry.entry
    meta:
      type: bar.npc
      name: Barkeep Marta
      role: bartender
    data:
      race: human
      occupation: bartender and tavern owner
      personality: warm but no-nonsense, protective of her regulars
      speech_style: direct and practical, calls everyone "love" or "dear"
      quirk: always polishing a glass
      secret: secretly waters down drinks for regulars who've had too much
      drunk_level: sober
      drunk_desc: always sober — on duty
      mood: keeping an eye on the crowd
      interjection_chance: 0.3

  - name: npc.bard
    kind: registry.entry
    meta:
      type: bar.npc
      name: Lyric the Lute
      role: regular
    data:
      race: half-elf
      occupation: bard between gigs
      personality: theatrically dramatic and easily inspired
      speech_style: speaks in rhyme when excited, drops song lyrics into conversation
      quirk: strums an invisible lute while talking
      secret: is tone-deaf but nobody has the heart to tell them
      drunk_level: tipsy
      drunk_desc: relaxed, friendly, occasionally slurring
      mood: looking for inspiration for a new ballad
      interjection_chance: 0.2

  # ── CLI Process ────────────────────────────────────────────
  - name: cli
    meta:
      command:
        name: bar
        short: Go to bar
    kind: process.lua
    source: file://cli.lua
    method: main
    modules:
      - io
      - time
      - registry
      - logger
